
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>GDAL VRT approach &#8212; Sentinel-1 RTC data workflows with xarray</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Microsoft Planetary Computer Sentinel-1 RTC Imagery" href="PC_RTC.html" />
    <link rel="prev" title="Xarray open_mfdataset() approach" href="asf_local_mf.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Sentinel-1 RTC data workflows with xarray</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Thanks for coming to this site! Please note it is under construction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="ch1_root.html">
   Data cleaning and organization
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="asf_local_mf.html">
     Xarray
     <code class="docutils literal notranslate">
      <span class="pre">
       open_mfdataset()
      </span>
     </code>
     approach
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     GDAL VRT approach
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="PC_RTC.html">
     Microsoft Planetary Computer Sentinel-1 RTC Imagery
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="ch2_root.html">
   Dataset comparison and preliminary analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="dataset_comparison_new.html">
     RTC dataset comparison
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rtc_timeseries.html">
     RTC time series analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="questions.html">
   Tutorial structure questions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="todo.html">
   To do
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="References.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/e-marshall/sentinel_rtc/main?urlpath=tree/asf_local_vrt_troubleshoot.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/e-marshall/sentinel_rtc"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/asf_local_vrt_troubleshoot.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#software-and-setup">
   Software and setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-slc-granule-id-from-readme">
   Extract SLC granule ID from readme
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-in-vector-data">
     Read in vector data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-vrt-objects">
   Create VRT objects
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-metadata">
   Extract metadata
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#clip-by-vector-data">
     Clip by vector data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#merge-metadata">
   Merge metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#format-acquisition-time">
   Format acquisition time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-orbital-direction-coord">
   Add orbital direction coord
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#handle-nodata-values">
   Handle nodata values
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>GDAL VRT approach</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#software-and-setup">
   Software and setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-slc-granule-id-from-readme">
   Extract SLC granule ID from readme
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-in-vector-data">
     Read in vector data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-vrt-objects">
   Create VRT objects
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-metadata">
   Extract metadata
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#clip-by-vector-data">
     Clip by vector data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#merge-metadata">
   Merge metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#format-acquisition-time">
   Format acquisition time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-orbital-direction-coord">
   Add orbital direction coord
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#handle-nodata-values">
   Handle nodata values
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="gdal-vrt-approach">
<h1>GDAL VRT approach<a class="headerlink" href="#gdal-vrt-approach" title="Permalink to this headline">#</a></h1>
<p>This is a notebook demonstrates working with Sentinel-1 RTC imagery that has been processsed on the ASF On-Demand server and downloaded locally.</p>
<p>The access point for data in this notebook is a directory containing un-zipped directories of RTC scenes.</p>
<p>The previous notebook demonstrated an approach using the xarray function <code class="docutils literal notranslate"><span class="pre">open_mfdataset()</span></code>. Because of the size and some  characteristics of the dataset, this approach can be computationally expensive. Another way to approach reading in large amounts of data to avoid these issues is to use the gdal <code class="docutils literal notranslate"><span class="pre">build_vrt</span></code> command. VRT is short for GDAL Virtual Format. VRT objects create an xml file from a list of geotiff files. The xml contains a mapping of all of the specified raster files so that we essentially have the spatial information that would have been used to create the full data object, and all of the information we need for a clip. VRT objects are able to handle the mismatch of grids within the stack of files, so does not encounter the memory issues that we get when trying the <code class="docutils literal notranslate"><span class="pre">xr.open_mfdataset()</span></code> approach with dask.</p>
<p>You will see that this approach let’s you read in the data stack with less computational expense, but because of how the data is represented, some metadata is lost and must be re-structured. We will go through those steps here, with explanations of the xarray tools we use along the way.</p>
<p><strong>Learning goals</strong>:</p>
<p><em>add specific xarray methods used</em></p>
<p>Handling large amounts of locally stored data</p>
<ul class="simple">
<li><p>organize large set of geotiff files stored locally</p></li>
<li><p>reading in large data stacks as xarray objects using gdal build VRT</p></li>
</ul>
<p><strong>NOTE</strong>: code for submitting HyP jobs still needs to be added back in</p>
<section id="software-and-setup">
<h2>Software and setup<a class="headerlink" href="#software-and-setup" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rio</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">holoviews</span> <span class="k">as</span> <span class="nn">hv</span>
<span class="kn">from</span> <span class="nn">holoviews</span> <span class="kn">import</span> <span class="n">opts</span>
<span class="kn">import</span> <span class="nn">markdown</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">s1_tools</span> <span class="kn">import</span> <span class="n">points2coords</span>
</pre></div>
</div>
</div>
</div>
<p><strong>instead of re-writing every function that’s used again, going to read them in from s1_tools package after they’ve been defined in a notebook - so next cell should be deleted</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read in PC data (We will use this later for a comparison)</span>
<span class="c1">#we&#39;ll use this function to get bounding box coordinates from a list of points </span>
<span class="k">def</span> <span class="nf">points2coords</span><span class="p">(</span><span class="n">pt_ls</span><span class="p">):</span> <span class="c1">#should be [xmin, ymin, xmax, ymax]</span>
    
    <span class="n">coords_ls</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pt_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">pt_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_ls</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                 <span class="p">(</span><span class="n">pt_ls</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pt_ls</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="n">pt_ls</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pt_ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                 <span class="p">(</span><span class="n">pt_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_ls</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">coords_ls</span>
    
</pre></div>
</div>
</div>
</div>
<p>Set up some string variables for directory paths. We need to pass <code class="docutils literal notranslate"><span class="pre">xr.open_mfdataset()</span></code> a list of all files to read in. Currently, the file structure is organized so that each scene has its own sub-directory within <code class="docutils literal notranslate"><span class="pre">unzipped_keep</span></code>. Within each sub-directory are several files - we want to extract the tif files containing RTC imagery for the VV and VH polarizations for each scene. The function <code class="docutils literal notranslate"><span class="pre">extract_tif_fnames()</span></code> takes a path to the directory containing the sub-directories for all scenes and returns a list of the filenames for VV-polarization tif files and a separate list of filenames for VH-polarization tif files. This is the same as what we used in the previous notebook but with an additional list of names of README files for each Sentinel-1 scene. This will be used to extract important metadata later on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dir_path_all</span> <span class="o">=</span> <span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/asf_rtc_data/unzipped_keep/&#39;</span>
<span class="n">scenes_ls</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path_all</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_tif_fnames</span><span class="p">(</span><span class="n">scene_path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; return a list of files associated with a single S1 scene&#39;&#39;&#39;</span>
    <span class="n">scene_files_ls</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path_all</span> <span class="o">+</span> <span class="n">scene_path</span><span class="p">)</span>
        
    <span class="c1">#make object for readme file</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">scene_files_ls</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;README.md.txt&#39;</span><span class="p">)]</span>
    
    <span class="n">scene_files_vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">scene_files_ls</span> <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_VH.tif&#39;</span><span class="p">)]</span>
    <span class="n">scene_files_vh</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">scene_files_ls</span> <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_VV.tif&#39;</span><span class="p">)]</span>
    <span class="n">scene_files_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">scene_files_ls</span> <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ls_map.tif&#39;</span><span class="p">)]</span>
    <span class="c1">#scene_files_rm = [file for file in scene_files_ls if file.endswith(&#39;README.md.txt&#39;)]</span>
    
    <span class="k">return</span> <span class="n">scene_files_vv</span><span class="p">,</span> <span class="n">scene_files_vh</span><span class="p">,</span> <span class="n">scene_files_ls</span><span class="p">,</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">dir_path_all</span> <span class="o">=</span> <span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/asf_rtc_data/unzipped_keep/&#39;</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">scenes_ls</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path_all</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="k">def</span> <span class="nf">extract_tif_fnames</span><span class="p">(</span><span class="n">scene_path</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="sd">&#39;&#39;&#39; return a list of files associated with a single S1 scene&#39;&#39;&#39;</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/home/emmamarshall/Desktop/siparcs/asf_rtc_data/unzipped_keep/&#39;
</pre></div>
</div>
</div>
</div>
<p>Every scene will have the following four elements:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extract_tif_fnames</span><span class="p">(</span><span class="n">scenes_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">extract_tif_fnames</span><span class="p">(</span><span class="n">scenes_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;extract_tif_fnames&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now we need to attach the filenames to the full path to each file. We will end up with a list of full paths to VV and VH band imagery, layover shadow map and README files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpaths_vv</span><span class="p">,</span> <span class="n">fpaths_vh</span><span class="p">,</span> <span class="n">fpaths_ls</span><span class="p">,</span> <span class="n">fpaths_rm</span> <span class="o">=</span> <span class="p">[],[],[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scenes_ls</span><span class="p">)):</span>
    
    <span class="n">good_files</span> <span class="o">=</span> <span class="n">extract_tif_fnames</span><span class="p">(</span><span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
    
    <span class="n">path_vh</span> <span class="o">=</span> <span class="n">dir_path_all</span> <span class="o">+</span> <span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">good_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">path_vv</span> <span class="o">=</span> <span class="n">dir_path_all</span> <span class="o">+</span> <span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">good_files</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">path_ls</span> <span class="o">=</span> <span class="n">dir_path_all</span> <span class="o">+</span> <span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">good_files</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">path_readme</span> <span class="o">=</span> <span class="n">dir_path_all</span> <span class="o">+</span> <span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">good_files</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">fpaths_vv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_vv</span><span class="p">)</span>
    <span class="n">fpaths_vh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_vh</span><span class="p">)</span>
    <span class="n">fpaths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_ls</span><span class="p">)</span>
    <span class="n">fpaths_rm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_readme</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fpaths_vv</span><span class="p">,</span> <span class="n">fpaths_vh</span><span class="p">,</span> <span class="n">fpaths_ls</span><span class="p">,</span> <span class="n">fpaths_rm</span> <span class="o">=</span> <span class="p">[],[],[],</span> <span class="p">[]</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scenes_ls</span><span class="p">)):</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">good_files</span> <span class="o">=</span> <span class="n">extract_tif_fnames</span><span class="p">(</span><span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">path_vh</span> <span class="o">=</span> <span class="n">dir_path_all</span> <span class="o">+</span> <span class="n">scenes_ls</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">good_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;scenes_ls&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-slc-granule-id-from-readme">
<h2>Extract SLC granule ID from readme<a class="headerlink" href="#extract-slc-granule-id-from-readme" title="Permalink to this headline">#</a></h2>
<p>The original granule ID associated with the Sentinel-1 data product published by the European Space Agency contains metadata that it would be helpful for us to attach to our xarray objects. The README file that is associated with every scene contains the source granule used to generate that product.</p>
<p>The following two functions will be used to extract the source granule ID from each README file then to attatch the ID as a coordinate to the xarray object containing the SAR imagery.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_granule_id</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; this function takes a filepath to the readme associated with an S1 scene and returns the source granule id used to generate the RTC imagery&#39;&#39;&#39;</span> 

    <span class="n">md</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="c1">#this text predates granule ID in readme</span>
    <span class="n">gran_str</span> <span class="o">=</span> <span class="s1">&#39;The source granule used to generate the products contained in this folder is:</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">gran_str</span><span class="p">)</span>
    <span class="c1">#isolate the granule id</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">67</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">post</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_granule_coord</span><span class="p">(</span><span class="n">readme_fpaths_ls</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;this fn takes a list of the filepaths to every read me, extracts the granule ID, </span>
<span class="sd">    extracts acq date for each granule ID, organizes this as an array that</span>
<span class="sd">    can be assigned as a coord to an xr object&#39;&#39;&#39;</span>
    
    <span class="n">granule_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_granule_id</span><span class="p">(</span><span class="n">readme_fpaths_ls</span><span class="p">[</span><span class="n">element</span><span class="p">])</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">readme_fpaths_ls</span><span class="p">))]</span>
    
    <span class="n">acq_date</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">granule</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">25</span><span class="p">])</span> <span class="k">for</span> <span class="n">granule</span> <span class="ow">in</span> <span class="n">granule_ls</span><span class="p">]</span>

    <span class="n">granule_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">granule_ls</span><span class="p">,</span> 
                              <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">],</span>
                              <span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acq_date&#39;</span><span class="p">:</span><span class="n">acq_date</span><span class="p">},</span>
                             <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;source granule ID for ASF-processed S1 RTC imagery, extracted from README files for each scene&#39;</span><span class="p">},</span>
                             <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;granule_id&#39;</span><span class="p">)</span>
    <span class="c1">#granule_da = granule_da.sortby(acq_date)</span>
    <span class="n">granule_da</span> <span class="o">=</span> <span class="n">granule_da</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">granule_da</span><span class="o">.</span><span class="n">acq_date</span><span class="p">)</span>
   <span class="c1"># granule_tuple = tuple(zip(acq_date, granule_ls))</span>
    
    <span class="k">return</span> <span class="n">granule_da</span>
</pre></div>
</div>
</div>
</div>
<p>The object below (<code class="docutils literal notranslate"><span class="pre">granule_da</span></code>) is a 2-dimensional <code class="docutils literal notranslate"><span class="pre">xr.DataArray</span></code> that contains an acquisition date coordinate dimension and an array of Sentinel-1 granule IDs. It will be used later when we are merging metadata with our imagery object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">granule_da</span> <span class="o">=</span> <span class="n">make_granule_coord</span><span class="p">(</span><span class="n">fpaths_rm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">granule_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">acq_date</span><span class="o">=</span><span class="s1">&#39;2021-06-02&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">62</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">g</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">granule_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">acq_date</span><span class="o">=</span><span class="s1">&#39;2021-06-02&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">62</span><span class="p">])</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/core/dataarray.py:1420,</span> in <span class="ni">DataArray.sel</span><span class="nt">(self, indexers, method, tolerance, drop, **indexers_kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1310</span> <span class="k">def</span> <span class="nf">sel</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1311</span>     <span class="bp">self</span><span class="p">:</span> <span class="n">T_DataArray</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1312</span>     <span class="n">indexers</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1316</span>     <span class="o">**</span><span class="n">indexers_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1317</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T_DataArray</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1318</span>     <span class="sd">&quot;&quot;&quot;Return a new DataArray whose data is given by selecting index</span>
<span class="g g-Whitespace">   </span><span class="mi">1319</span><span class="sd">     labels along the specified dimension(s).</span>
<span class="g g-Whitespace">   </span><span class="mi">1320</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">1418</span><span class="sd">     Dimensions without coordinates: points</span>
<span class="g g-Whitespace">   </span><span class="mi">1419</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1420</span>     <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_temp_dataset</span><span class="p">()</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1421</span>         <span class="n">indexers</span><span class="o">=</span><span class="n">indexers</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1422</span>         <span class="n">drop</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1423</span>         <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1424</span>         <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1425</span>         <span class="o">**</span><span class="n">indexers_kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1426</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1427</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_temp_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/core/dataset.py:2533,</span> in <span class="ni">Dataset.sel</span><span class="nt">(self, indexers, method, tolerance, drop, **indexers_kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2472</span> <span class="sd">&quot;&quot;&quot;Returns a new dataset with each array indexed by tick labels</span>
<span class="g g-Whitespace">   </span><span class="mi">2473</span><span class="sd"> along the specified dimension(s).</span>
<span class="g g-Whitespace">   </span><span class="mi">2474</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">2530</span><span class="sd"> DataArray.sel</span>
<span class="g g-Whitespace">   </span><span class="mi">2531</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">2532</span> <span class="n">indexers</span> <span class="o">=</span> <span class="n">either_dict_or_kwargs</span><span class="p">(</span><span class="n">indexers</span><span class="p">,</span> <span class="n">indexers_kwargs</span><span class="p">,</span> <span class="s2">&quot;sel&quot;</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2533</span> <span class="n">query_results</span> <span class="o">=</span> <span class="n">map_index_queries</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2534</span>     <span class="bp">self</span><span class="p">,</span> <span class="n">indexers</span><span class="o">=</span><span class="n">indexers</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span>
<span class="g g-Whitespace">   </span><span class="mi">2535</span> <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2537</span> <span class="k">if</span> <span class="n">drop</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2538</span>     <span class="n">no_scalar_variables</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/core/indexing.py:183,</span> in <span class="ni">map_index_queries</span><span class="nt">(obj, indexers, method, tolerance, **indexers_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>         <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">IndexSelResult</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">183</span>         <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>  <span class="c1"># type: ignore[call-arg]</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">merge_sel_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span> <span class="c1"># drop dimension coordinates found in dimension indexers</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span> <span class="c1"># (also drop multi-index if any)</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span> <span class="c1"># (.sel() already ensures alignment)</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/core/indexes.py:384,</span> in <span class="ni">PandasIndex.sel</span><span class="nt">(self, labels, method, tolerance)</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span>         <span class="s2">&quot;cannot use a dict-like object for selection on &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span>         <span class="s2">&quot;a dimension that does not have a MultiIndex&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">383</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">384</span>     <span class="n">label_array</span> <span class="o">=</span> <span class="n">normalize_label</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">385</span>     <span class="k">if</span> <span class="n">label_array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span>         <span class="n">label_value</span> <span class="o">=</span> <span class="n">as_scalar</span><span class="p">(</span><span class="n">label_array</span><span class="p">)</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/core/indexes.py:198,</span> in <span class="ni">normalize_label</span><span class="nt">(value, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span>     <span class="n">value</span> <span class="o">=</span> <span class="n">_asarray_tuplesafe</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span>     <span class="c1"># pd.Index built from coordinate with float precision != 64</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span>     <span class="c1"># see https://github.com/pydata/xarray/pull/3153 for details</span>
<span class="g g-Whitespace">    </span><span class="mi">196</span>     <span class="c1"># bypass coercing dtype for boolean indexers (ignore index)</span>
<span class="g g-Whitespace">    </span><span class="mi">197</span>     <span class="c1"># see https://github.com/pydata/xarray/issues/5727</span>
<span class="ne">--&gt; </span><span class="mi">198</span>     <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span> <span class="k">return</span> <span class="n">value</span>

<span class="ne">ValueError</span>: could not convert string to float: &#39;2021-06-02&#39;
</pre></div>
</div>
</div>
</div>
<p>The top line above is the full granule ID for the Sentinel-1 acquisition from 6/2/2021. You can read about the Sentinel-1 file naming convention <a class="reference external" href="https://sentinels.copernicus.eu/web/sentinel/user-guides/sentinel-1-sar/naming-conventions">here</a>, but for now we are interested in the 6-digit mission data take ID (<code class="docutils literal notranslate"><span class="pre">0480FD</span></code> in the above cell)</p>
<section id="read-in-vector-data">
<h3>Read in vector data<a class="headerlink" href="#read-in-vector-data" title="Permalink to this headline">#</a></h3>
<p><em>probably move this elsewehre in nb</em></p>
<p>We will use this vector data object later but we will read it in as a <code class="docutils literal notranslate"><span class="pre">geopandas.GeoDataFrame</span></code> object now. It is called PC aoi because the GeoJSON file was created off of the spatial extent of the SAR dat we will access from Microsoft Planetary Computer, in order to have comparable datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pc_aoi</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;https://github.com/e-marshall/sentinel1_rtc/raw/main/hma_rtc_aoi.geojson&#39;</span><span class="p">)</span>

<span class="n">pc_aoi</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((619420.000 3089790.000, 628100.000 3...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pc_aoi</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot: &gt;
</pre></div>
</div>
<img alt="_images/asf_local_vrt_troubleshoot_21_1.png" src="_images/asf_local_vrt_troubleshoot_21_1.png" />
</div>
</div>
</section>
</section>
<section id="create-vrt-objects">
<h2>Create VRT objects<a class="headerlink" href="#create-vrt-objects" title="Permalink to this headline">#</a></h2>
<p>We will be using the <code class="docutils literal notranslate"><span class="pre">gdalbuildvrt</span></code> command. You can find out more about it <a class="reference external" href="https://manpages.ubuntu.com/manpages/bionic/man1/gdalbuildvrt.1.html">here</a>. This command can make a VRT that either tiles the listed files into a large mosaic, or places them each in a separate band of the VRT. Because we are dealing with a temporal stack of images we want to use the <code class="docutils literal notranslate"><span class="pre">-separate</span></code> flag to place each file into a band of the VRT. </br>
Because we are making a VRT from a large number of files, we’ll supply a text file with the full path for each file rather than include these at the end of the command line. We’ll use the same lists of filepaths that we used in the <code class="docutils literal notranslate"><span class="pre">xr.open_mfdataset()</span></code> approach but this time we will write them to text files that we pass to the <code class="docutils literal notranslate"><span class="pre">gdalbuildvrt</span></code> command.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/data/written_data/s1_vv_fpaths.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fpaths_vv</span><span class="p">:</span>
        <span class="c1">#write each item on a new line</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/data/written_data/s1_vh_fpaths.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fpaths_vh</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/data/written_data/s1_ls_fpaths.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fpaths_ls</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/data/written_data/s1_vv_fpaths.txt&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fpaths_vv</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="c1">#write each item on a new line</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: &#39;/home/emmamarshall/Desktop/data/written_data/s1_vv_fpaths.txt&#39;
</pre></div>
</div>
</div>
</div>
<p><strong>fix the next cell use cell magic</strong></p>
<p>Next, we will use gdal command line tools to create the VRT objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#`gdalbuildvrt -separate -input_file_list /path/to/my_list.txt vrt_fname.vrt` &lt;/br&gt;</span>

<span class="c1">#% gdalbuildvrt -separate -input_file_list /home/emmamarshall/Desktop/data/written_data/s1_vv_fpaths.txt s1_stackVV.vrt</span>
<span class="c1">#% gdalbuildvrt -separate -input_file_list /home/emmamarshall/Desktop/data/written_data/s1_vh_fpaths.txt s1_stackVH.vrt</span>
<span class="c1">#% gdalbuildvrt -separate -input_file_list /home/emmamarshall/Desktop/data/written_data/s1_ls_fpaths.txt s1_stackLS.vrt</span>
</pre></div>
</div>
</div>
</div>
<p>Read in the VRT files using the <code class="docutils literal notranslate"><span class="pre">rioxarray</span></code> function <code class="docutils literal notranslate"><span class="pre">open_rasterio()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_vv</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/s1_stackVV.vrt&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">vrt_vh</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/s1_stackVH.vrt&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">vrt_ls</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/s1_stackLS.vrt&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/backends/file_manager.py:201,</span> in <span class="ni">CachingFileManager._acquire_with_cache_info</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">201</span>     <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/backends/lru_cache.py:55,</span> in <span class="ni">LRUCache.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">55</span>     <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="ne">KeyError</span>: [&lt;function open at 0x7f324fe013f0&gt;, (&#39;/home/emmamarshall/Desktop/siparcs/s1_stackVV.vrt&#39;,), &#39;r&#39;, ((&#39;sharing&#39;, False),)]

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">CPLE_OpenFailedError</span><span class="g g-Whitespace">                      </span>Traceback (most recent call last)
<span class="nn">File rasterio/_base.pyx:302,</span> in <span class="ni">rasterio._base.DatasetBase.__init__</span><span class="nt">()</span>

<span class="nn">File rasterio/_base.pyx:213,</span> in <span class="ni">rasterio._base.open_dataset</span><span class="nt">()</span>

<span class="nn">File rasterio/_err.pyx:217,</span> in <span class="ni">rasterio._err.exc_wrap_pointer</span><span class="nt">()</span>

<span class="ne">CPLE_OpenFailedError</span>: /home/emmamarshall/Desktop/siparcs/s1_stackVV.vrt: No such file or directory

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">RasterioIOError</span><span class="g g-Whitespace">                           </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_vv</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/s1_stackVV.vrt&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">vrt_vh</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/s1_stackVH.vrt&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">vrt_ls</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s1">&#39;/home/emmamarshall/Desktop/siparcs/s1_stackLS.vrt&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/rioxarray/_io.py:916,</span> in <span class="ni">open_rasterio</span><span class="nt">(filename, parse_coordinates, chunks, cache, lock, masked, mask_and_scale, variable, group, default_name, decode_times, decode_timedelta, **open_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">914</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span>         <span class="n">manager</span> <span class="o">=</span> <span class="n">URIManager</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">open_kwargs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">916</span>     <span class="n">riods</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">917</span>     <span class="n">captured_warnings</span> <span class="o">=</span> <span class="n">rio_warnings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">919</span> <span class="c1"># raise the NotGeoreferencedWarning if applicable</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/backends/file_manager.py:183,</span> in <span class="ni">CachingFileManager.acquire</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">168</span> <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needs_lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">169</span>     <span class="sd">&quot;&quot;&quot;Acquire a file object from the manager.</span>
<span class="g g-Whitespace">    </span><span class="mi">170</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">171</span><span class="sd">     A new file is only opened if it has expired from the</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span><span class="sd">         An open file object, as returned by ``opener(*args, **kwargs)``.</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">183</span>     <span class="n">file</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquire_with_cache_info</span><span class="p">(</span><span class="n">needs_lock</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span>     <span class="k">return</span> <span class="n">file</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/xarray/backends/file_manager.py:207,</span> in <span class="ni">CachingFileManager._acquire_with_cache_info</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span>     <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
<span class="ne">--&gt; </span><span class="mi">207</span> <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opener</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="c1"># ensure file doesn&#39;t get overridden when opened again</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/rasterio/env.py:442,</span> in <span class="ni">ensure_env_with_credentials.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">439</span>     <span class="n">session</span> <span class="o">=</span> <span class="n">DummySession</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">441</span> <span class="k">with</span> <span class="n">env_ctor</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">442</span>     <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

<span class="nn">File ~/micromamba-root/envs/s1rtc/lib/python3.10/site-packages/rasterio/__init__.py:277,</span> in <span class="ni">open</span><span class="nt">(fp, mode, driver, width, height, count, crs, transform, dtype, nodata, sharing, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span> <span class="n">path</span> <span class="o">=</span> <span class="n">_parse_path</span><span class="p">(</span><span class="n">raw_dataset_path</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">276</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">277</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetReader</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span> <span class="n">sharing</span><span class="o">=</span><span class="n">sharing</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span> <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_writer_for_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span>         <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span> <span class="n">sharing</span><span class="o">=</span><span class="n">sharing</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>     <span class="p">)</span>

<span class="nn">File rasterio/_base.pyx:304,</span> in <span class="ni">rasterio._base.DatasetBase.__init__</span><span class="nt">()</span>

<span class="ne">RasterioIOError</span>: /home/emmamarshall/Desktop/siparcs/s1_stackVV.vrt: No such file or directory
</pre></div>
</div>
</div>
</div>
<p>Building the <code class="docutils literal notranslate"><span class="pre">VRT</span></code> object assigns every object in the .txt file to a different band. In doing this, we lost the metadata that is associated with the files. We use a function that is similar (in some ways) to the <code class="docutils literal notranslate"><span class="pre">preprocess</span></code> call above, to extract metadata from the file name and attach it to the xarray objects that we read in from VRTs.</p>
</section>
<section id="extract-metadata">
<h2>Extract metadata<a class="headerlink" href="#extract-metadata" title="Permalink to this headline">#</a></h2>
<p>The following function is very similar to the <code class="docutils literal notranslate"><span class="pre">preprocess()</span></code> function used in the previous notebook. It extracts metadata contained in the filename and organizes it as a dictionary that can be attached to an xarray object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_metadata_attrs</span><span class="p">(</span><span class="n">inputfname</span><span class="p">):</span>
    
    <span class="c1">#vv_fn = da_orig.encoding[&#39;source&#39;][113:]</span>
    <span class="n">vv_fn</span> <span class="o">=</span> <span class="n">inputfname</span><span class="p">[</span><span class="mi">113</span><span class="p">:]</span>
    
    <span class="n">sensor</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">beam_mode</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">acq_date_raw</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span> <span class="c1">#need to parse further</span>
    <span class="n">acq_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_date_raw</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1">#print(acq_date)</span>
    <span class="n">acq_time</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span>
    <span class="n">pol_type</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">25</span><span class="p">]</span> <span class="c1"># dual pol ...</span>
   <span class="c1"># primary_pol = vv_fn[25:26] # VV ...</span>
    <span class="n">orbit_type</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">25</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span>
   <span class="c1"># orbit_type = vv_fn[26:27] #Precise (P), Restituted (R), or Original Predicted (O)</span>
    <span class="n">terrain_correction_pixel_spacing</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span> <span class="c1">#Terrain Correction Pixel Spacing</span>
    <span class="n">rtc_alg</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">34</span><span class="p">]</span> <span class="c1">#Software Package Used: GAMMA (G)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="c1">#  Gamma-0 (g) or Sigma-0 (s) Output</span>
    <span class="n">output_type</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="c1">#Power (p) or Decibel (d) or Amplitude (a) Output</span>
    <span class="n">masked</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span>  <span class="c1">#Unmasked (u) or Water Masked (w)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span>  <span class="c1"># Not Filtered (n) or Filtered (f)</span>
    <span class="n">area</span> <span class="o">=</span>  <span class="n">vv_fn</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span>       <span class="c1"># Entire Area (e) or Clipped Area (c)</span>
    <span class="n">tbd</span> <span class="o">=</span>   <span class="n">vv_fn</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span>   <span class="c1">#Dead Reckoning (d) or DEM Matching (m)</span>
   <span class="c1"># product_id  = vv_fn[56:62]  #Product ID</span>
    <span class="n">product_id</span> <span class="o">=</span> <span class="n">vv_fn</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">46</span><span class="p">]</span>

    <span class="n">attrs_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="n">sensor</span><span class="p">,</span>
                        <span class="s1">&#39;beam_mode&#39;</span><span class="p">:</span><span class="n">beam_mode</span><span class="p">,</span> 
                        <span class="s1">&#39;acquisition_date&#39;</span> <span class="p">:</span> <span class="n">acq_date</span><span class="p">,</span>
                        <span class="s1">&#39;acquisition_time&#39;</span><span class="p">:</span> <span class="n">acq_time</span><span class="p">,</span>
                        <span class="s1">&#39;polarisation_type&#39;</span><span class="p">:</span> <span class="n">pol_type</span><span class="p">,</span>
                     <span class="c1">#  &#39;primary_polarisation&#39;: primary_pol,</span>
                        <span class="s1">&#39;orbit_type&#39;</span><span class="p">:</span> <span class="n">orbit_type</span><span class="p">,</span>
                        <span class="s1">&#39;terrain_correction_pixel_spacing&#39;</span> <span class="p">:</span> <span class="n">terrain_correction_pixel_spacing</span><span class="p">,</span>
                        <span class="s1">&#39;output_format&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
                        <span class="s1">&#39;output_type&#39;</span><span class="p">:</span> <span class="n">output_type</span><span class="p">,</span>
                        <span class="s1">&#39;masked&#39;</span> <span class="p">:</span> <span class="n">masked</span><span class="p">,</span>
                        <span class="s1">&#39;filtered&#39;</span><span class="p">:</span><span class="n">filtered</span><span class="p">,</span>
                        <span class="s1">&#39;area&#39;</span><span class="p">:</span><span class="n">area</span><span class="p">,</span>
                        <span class="s1">&#39;product_id&#39;</span><span class="p">:</span> <span class="n">product_id</span> 
                 <span class="p">}</span>
    <span class="k">return</span> <span class="n">attrs_dict</span>
</pre></div>
</div>
</div>
</div>
<p>The acquisition dates extracted from the VV, VH and Ls geotiff files should be identical, but we read in all three here just to confirm:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acq_dates_vh</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_vh</span><span class="p">[</span><span class="n">file</span><span class="p">])[</span><span class="s1">&#39;acquisition_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_vh</span><span class="p">))]</span>
<span class="n">acq_dates_vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">[</span><span class="n">file</span><span class="p">])[</span><span class="s1">&#39;acquisition_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">))]</span>
<span class="n">acq_dates_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_ls</span><span class="p">[</span><span class="n">file</span><span class="p">])[</span><span class="s1">&#39;acquisition_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<p>Do the same for acquisition time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">acq_times_vh</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_vh</span><span class="p">[</span><span class="n">file</span><span class="p">])[</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">],</span><span class="s1">&#39;T%H%M%S&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_vh</span><span class="p">))]</span>
<span class="n">acq_times_vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">[</span><span class="n">file</span><span class="p">])[</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">],</span><span class="s1">&#39;T%H%M%S&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">))]</span>
<span class="n">acq_times_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_ls</span><span class="p">[</span><span class="n">file</span><span class="p">])[</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">],</span><span class="s1">&#39;T%H%M%S&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_ls</span><span class="p">))]</span>

<span class="c1">#acq_times_vv = [extract_metadata_attrs(fpaths_vv[file])[&#39;acquisition_time&#39;].strftime(&#39;%hh%mm%ss&#39;) for file in range(len(fpaths_vv))]</span>
<span class="c1">#acq_times_ls = [extract_metadata_attrs(fpaths_ls[file])[&#39;acquisition_time&#39;].strftime(&#39;%hh%mm%ss&#39;) for file in range(len(fpaths_vv))]</span>
</pre></div>
</div>
</div>
</div>
<p>The acquisition dates for VV, VH and LS <strong>should be</strong> the same. As a check, you can confirm this by creating both objects and comparing them.`</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acq_dates_vh</span> <span class="o">==</span> <span class="n">acq_dates_vv</span> <span class="o">==</span> <span class="n">acq_dates_ls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acq_times_vh</span> <span class="o">==</span> <span class="n">acq_times_vv</span> <span class="o">==</span> <span class="n">acq_times_ls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>We can now assign the list of acquisition dates as coordinates to the xarray objects. Use <code class="docutils literal notranslate"><span class="pre">pd.to_datetime()</span></code> to do this as time-aware coordinate values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_vv</span> <span class="o">=</span> <span class="n">vrt_vv</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_dates_vv</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)})</span>
<span class="n">vrt_vh</span> <span class="o">=</span> <span class="n">vrt_vh</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_dates_vh</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)})</span>
<span class="n">vrt_ls</span> <span class="o">=</span> <span class="n">vrt_ls</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_dates_ls</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_vv</span> <span class="o">=</span> <span class="n">vrt_vv</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_dates_vv</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)})</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">vrt_vh</span> <span class="o">=</span> <span class="n">vrt_vh</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_dates_vh</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)})</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">vrt_ls</span> <span class="o">=</span> <span class="n">vrt_ls</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">acq_dates_ls</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)})</span>

<span class="ne">NameError</span>: name &#39;vrt_vv&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Merge the three <code class="docutils literal notranslate"><span class="pre">xr.DataArrays</span></code> together into an <code class="docutils literal notranslate"><span class="pre">xr.Dataset</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_merge</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;vv&#39;</span><span class="p">:</span><span class="n">vrt_vv</span><span class="p">,</span> 
                      <span class="s1">&#39;vh&#39;</span><span class="p">:</span><span class="n">vrt_vh</span><span class="p">,</span>
                       <span class="s1">&#39;ls&#39;</span><span class="p">:</span><span class="n">vrt_ls</span><span class="p">})</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="s1">&#39;acq_date&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="s1">&#39;acq_date&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_merge</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;vv&#39;</span><span class="p">:</span><span class="n">vrt_vv</span><span class="p">,</span> 
<span class="g g-Whitespace">      </span><span class="mi">2</span>                       <span class="s1">&#39;vh&#39;</span><span class="p">:</span><span class="n">vrt_vh</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                        <span class="s1">&#39;ls&#39;</span><span class="p">:</span><span class="n">vrt_ls</span><span class="p">})</span><span class="o">.</span><span class="n">rename_dims</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="s1">&#39;acq_date&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;band&#39;</span><span class="p">:</span><span class="s1">&#39;acq_date&#39;</span><span class="p">})</span>

<span class="ne">NameError</span>: name &#39;vrt_vv&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_merge</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_merge</span>

<span class="ne">NameError</span>: name &#39;vrt_merge&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>The files are not organized by time in the directory, so the files are not read in in temporal order when we create the VRT and <code class="docutils literal notranslate"><span class="pre">xr.Dataset</span></code> objects. Once we have attached the temporal metadata to the xarray objects composed from VRT, we can use <code class="docutils literal notranslate"><span class="pre">.sortby()</span></code> to organize the dataset along time time dimension:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_merge</span> <span class="o">=</span> <span class="n">vrt_merge</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">vrt_merge</span><span class="o">.</span><span class="n">acq_date</span><span class="p">)</span>
<span class="n">vrt_merge</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_merge</span> <span class="o">=</span> <span class="n">vrt_merge</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">vrt_merge</span><span class="o">.</span><span class="n">acq_date</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">vrt_merge</span>

<span class="ne">NameError</span>: name &#39;vrt_merge&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>You can see that the chunking here is much more reasonable, with 1236 total chunks compared to 103 or 317,240 chunks from the <code class="docutils literal notranslate"><span class="pre">open_mfdataset()</span></code> approach.</p>
<section id="clip-by-vector-data">
<h3>Clip by vector data<a class="headerlink" href="#clip-by-vector-data" title="Permalink to this headline">#</a></h3>
<p>Clip the full object by the same AOI as above. Just as in the last notebook, we will use the <a class="reference external" href="https://corteva.github.io/rioxarray/stable/examples/clip_geom.html"><code class="docutils literal notranslate"><span class="pre">rioxarray.clip()</span></code> method</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_clip</span> <span class="o">=</span> <span class="n">vrt_merge</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pc_aoi</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">pc_aoi</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">vrt_clip</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_clip</span> <span class="o">=</span> <span class="n">vrt_merge</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pc_aoi</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">pc_aoi</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">vrt_clip</span>

<span class="ne">NameError</span>: name &#39;vrt_merge&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="merge-metadata">
<h2>Merge metadata<a class="headerlink" href="#merge-metadata" title="Permalink to this headline">#</a></h2>
<p>We had important metadata stored in the individual filenames of each Sentinel-1 scene that was dropped when we converted them to VRT objects. Let’s use the original filenames to extract the metadata and assign the data as coordinates of our formatted xarray object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">meta_attrs_ls_vv</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_metadata_attrs</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">[</span><span class="n">file</span><span class="p">])</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fpaths_vv</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_metadata_as_coords</span><span class="p">(</span><span class="n">input_ls</span><span class="p">,</span> <span class="n">input_xr</span><span class="p">):</span>
    
    <span class="n">meta_dict</span> <span class="o">=</span> <span class="n">input_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">attrs_dicts</span><span class="p">,</span> <span class="n">keys_ls</span> <span class="o">=</span> <span class="p">[],[]</span>
    
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta_dict</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;acquisition_date&#39;</span><span class="p">:</span> 
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">key_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:[</span><span class="n">input_ls</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_ls</span><span class="p">))]}</span>
            <span class="n">ticker</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">attrs_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_dict</span><span class="p">)</span>
            <span class="n">keys_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">full_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys_ls</span><span class="p">,</span> <span class="n">attrs_dicts</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">full_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        
        <span class="n">coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">input_xr</span> <span class="o">=</span> <span class="n">input_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span><span class="n">coord</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">input_xr</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span> <span class="o">=</span> <span class="n">assign_metadata_as_coords</span><span class="p">(</span><span class="n">meta_attrs_ls_vv</span><span class="p">,</span> <span class="n">vrt_clip</span><span class="p">)</span>
<span class="c1">#vrt_full[&#39;granule_id&#39;] = granule_da</span>
<span class="c1">#vrt_full = vrt_full.set_coords({&#39;granule_id&#39;: vrt_full.granule_id})</span>
<span class="n">vrt_full</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">([</span><span class="n">vrt_full</span><span class="p">,</span> <span class="n">granule_da</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span> <span class="o">=</span> <span class="n">assign_metadata_as_coords</span><span class="p">(</span><span class="n">meta_attrs_ls_vv</span><span class="p">,</span> <span class="n">vrt_clip</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="c1">#vrt_full[&#39;granule_id&#39;] = granule_da</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1">#vrt_full = vrt_full.set_coords({&#39;granule_id&#39;: vrt_full.granule_id})</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">vrt_full</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">([</span><span class="n">vrt_full</span><span class="p">,</span> <span class="n">granule_da</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;vrt_clip&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">28</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">([</span><span class="n">vrt_full</span><span class="p">,</span> <span class="n">granule_da</span><span class="p">])</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;granule_id&#39;</span><span class="p">:</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">granule_id</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">combine_by_coords</span><span class="p">([</span><span class="n">vrt_full</span><span class="p">,</span> <span class="n">granule_da</span><span class="p">])</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;granule_id&#39;</span><span class="p">:</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">granule_id</span><span class="p">})</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="format-acquisition-time">
<h2>Format acquisition time<a class="headerlink" href="#format-acquisition-time" title="Permalink to this headline">#</a></h2>
<p>Acquisition time comes as a string with form <code class="docutils literal notranslate"><span class="pre">THHMMSS</span></code>. We would like the <code class="docutils literal notranslate"><span class="pre">acquisition_time</span></code> coordinate to be time aware. To do this, we’ll use the <code class="docutils literal notranslate"><span class="pre">np.vectorize()</span></code> <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.vectorize.html">function</a> to apply the string to datetime64 conversion to every element of the <code class="docutils literal notranslate"><span class="pre">acq_time</span></code> coordinate array. (better way to do this?)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">str_to_time</span><span class="p">(</span><span class="n">input_str</span><span class="p">):</span>
    <span class="c1">#print(input_str)</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">input_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">input_str</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">sec</span> <span class="o">=</span> <span class="n">input_str</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">hour</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">minute</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">sec</span>
    
    <span class="n">time_td</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">to_datetime64</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">time_td</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">format_acq_time_coord</span><span class="p">(</span><span class="n">input_xr</span><span class="p">):</span>
    
    <span class="n">time_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">str_to_time</span><span class="p">)</span>
    
    <span class="n">acq_times_format</span> <span class="o">=</span> <span class="n">time_str</span><span class="p">(</span><span class="n">input_xr</span><span class="p">[</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    
    <span class="n">input_xr</span><span class="p">[</span><span class="s1">&#39;acquisition_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq_times_format</span>
    
    <span class="k">return</span> <span class="n">input_xr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span> <span class="o">=</span> <span class="n">format_acq_time_coord</span><span class="p">(</span><span class="n">vrt_full</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span> <span class="o">=</span> <span class="n">format_acq_time_coord</span><span class="p">(</span><span class="n">vrt_full</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>You can see that all of the acquisition times are roughly either around 00:00 or 12:00 (check that these are UTC? what local time? 6 am / 6pm ish?). We can use the different times of the acquistitions to group the data by orbital direction ie. categorize acquisitions as ascending or descending passes</p>
</section>
<section id="add-orbital-direction-coord">
<h2>Add orbital direction coord<a class="headerlink" href="#add-orbital-direction-coord" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p>assign coord thats acq_time.dt.hour</p></li>
<li><p>use np where to translate hour to asc or desc</p></li>
<li><p>assign coord for orbital pass</p></li>
<li><p>drop dims for acq time, hour</p></li>
</ol>
<p>setting dtype = datetime64 f up the date??</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span><span class="o">.</span><span class="n">acquisition_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span><span class="o">.</span><span class="n">acquisition_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>need to get orbital_dir (or acq_hour) as a dimension rather than a non-dimensional coord</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_orbital_dir_coord</span><span class="p">(</span><span class="n">input_xr</span><span class="p">):</span>
    
    <span class="n">input_xr</span> <span class="o">=</span> <span class="n">input_xr</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s1">&#39;orbital_dir&#39;</span><span class="p">)</span>
    <span class="n">input_xr</span> <span class="o">=</span> <span class="n">input_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;acq_hour&#39;</span><span class="p">:</span><span class="n">input_xr</span><span class="o">.</span><span class="n">acquisition_time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">})</span>
    <span class="n">input_xr</span> <span class="o">=</span> <span class="n">input_xr</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">orbital_dir</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">input_xr</span><span class="o">.</span><span class="n">acq_hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">,</span><span class="s1">&#39;desc&#39;</span><span class="p">))</span>
    <span class="c1">#input_xr = input_xr.expand_dims(&#39;orbital_pass&#39;)</span>
                                     <span class="c1">#xr.where(input_xr.acq_hour == 0, &#39;asc&#39;, &#39;desc&#39;)})</span>
   <span class="c1"># input_xr = input_xr.assign_coords({&#39;orbital_pass&#39;:xr.where(input_xr.acq_hour == 0, &#39;asc&#39;, &#39;desc&#39;)})</span>
    <span class="c1">#input_xr = input_xr.expand_dims({&#39;pass&#39;:len(input_xr.orbital_pass)})</span>

   <span class="c1"># input_xr = input_xr.drop_dims([&#39;acquisition_time&#39;])</span>
    <span class="c1">#input_xr = input_xr.swap_dims({&#39;orbital_pass&#39;:&#39;orbital_dir&#39;})</span>
    
    <span class="k">return</span> <span class="n">input_xr</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span> <span class="o">=</span> <span class="n">add_orbital_dir_coord</span><span class="p">(</span><span class="n">vrt_full</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span> <span class="o">=</span> <span class="n">add_orbital_dir_coord</span><span class="p">(</span><span class="n">vrt_full</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="handle-nodata-values">
<h2>Handle nodata values<a class="headerlink" href="#handle-nodata-values" title="Permalink to this headline">#</a></h2>
<p>Another important difference between the <code class="docutils literal notranslate"><span class="pre">xr.open_mfdataset()</span></code> and VRT approaches is the handling of the nodata values. In the object built using <code class="docutils literal notranslate"><span class="pre">xr.open_mfdataset()</span></code>, nodata values are set to NaN while building the object from VRT files converts nodata values to zeros. This can cause a whole stream of problems later on so it is best to convert them to NaNs now. You can check the handling of nodata values in your dataset by using the <code class="docutils literal notranslate"><span class="pre">rio.nodata</span></code> accessor (shown below) which you can read about <a class="reference external" href="https://corteva.github.io/rioxarray/stable/getting_started/nodata_management.html">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">acq_date</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">38</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">acq_date</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>^ We want this to be a nan.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">rio.write_nodata()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_new</span> <span class="o">=</span> <span class="n">vrt_full</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_new</span> <span class="o">=</span> <span class="n">vrt_full</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>note sure why that’s not workiing rn</p>
</div>
<p>So using <code class="docutils literal notranslate"><span class="pre">xr.Dataset.where()</span></code> (don’t think this will actually overwrite the official nodata value, but it should replace the zeros:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vrt_full</span> <span class="o">=</span>  <span class="n">vrt_full</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">vrt_full</span> <span class="o">=</span>  <span class="n">vrt_full</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now we have all of the same metadata attached to our xarray datacube of Sentinel-1 RTC imagery that we had using the <code class="docutils literal notranslate"><span class="pre">xr.open_mfdataset()</span></code> approach, but we’ve done this with much less computational expense and a chunking strategy that is more appropriate for the nature of the dataset.</p>
<p>We’ll store this object to use it in a later notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">store</span> vrt_full
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>UsageError: Unknown variable &#39;vrt_full&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">power_to_db</span><span class="p">(</span><span class="n">input_arr</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">input_arr</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">power_to_db</span><span class="p">(</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">power_to_db</span><span class="p">(</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
<img alt="_images/asf_local_vrt_troubleshoot_82_1.png" src="_images/asf_local_vrt_troubleshoot_82_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power_to_db</span><span class="p">(</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">power_to_db</span><span class="p">(</span><span class="n">vrt_full</span><span class="o">.</span><span class="n">vv</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;vrt_full&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="asf_local_mf.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Xarray <code class="docutils literal notranslate"><span class="pre">open_mfdataset()</span></code> approach</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="PC_RTC.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Microsoft Planetary Computer Sentinel-1 RTC Imagery</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By emma marshall<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>